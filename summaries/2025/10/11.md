# Activity Summary for 10/11/2025

## 1:37:38 PM
The log captures two entries for the file `c:\Users\zhiha\MDP_Shared\MDP-Maxxing\RPI_Server\Week9.py`, recorded on 10/11/2025 at 12:49:21 PM and 12:49:26 PM respectively.

**File-Specific Updates:**
For the file `c:\Users\zhiha\MDP_Shared\MDP-Maxxing\RPI_Server\Week9.py`, there are no discernible code changes between the two provided timestamps. The content for both entries is identical and appears to be truncated at the end of the `stm_queue_listener` method.

The `Week9.py` file defines a `RaspberryPi` class, which orchestrates various components for an RPI-based system:
*   **Communication:** Utilizes `AndroidLink` for Android communication and `STMLink` for STM microcontroller interaction. It manages separate queues (`android_queue`, `rpi_action_queue`, `stm_queue`) and events (`android_stop_event`, `stm_done`, `stm_received`, `stm_stop_event`) for asynchronous operations.
*   **Hardware Integration:** Handles `PiCamera` initialization and cleanup on Raspberry Pi (with a fallback for non-RPI environments).
*   **Core Logic:** Implements `start` and `stop` methods to manage the lifecycle of hardware links and listener threads. It includes methods for sending commands to STM and waiting for responses (`send_and_wait`).
*   **Android Interaction:** `android_io_process` manages the connection, sending, and receiving of messages with Android. It checks API status and processes incoming commands like `sendArena` (for obstacle data) and `stitch-image`.
*   **RPI Action Queue Listener:** `rpi_queue_listener` processes commands from its internal queue, directing "control" commands to the STM queue and handling "stitch-image" requests.
*   **STM Queue Listener:** `stm_queue_listener` sends commands from the `stm_queue` to the STM and handles specific responses, such as the `<SNAPS>` command. Upon a successful `<SNAPS>` command, it captures an image, uploads it to an `IMAGE_SERVER`, and sends image recognition results (including obstacle ID, image ID, and coordinates) back to Android.
*   **Shared State:** Uses `multiprocessing.Manager` to manage shared lists for `obstacles` and `obstacle_order` between processes.

**Timestamps of Significant Changes:**
The significant event is the recording of the file's state at two very close timestamps: 10/11/2025, 12:49:21 PM and 10/11/2025, 12:49:26 PM. The identical content implies either no changes were made in this 5-second interval, or the change was outside the provided log snippet.

**Patterns or Recurring Elements:**
The primary pattern observed is the repeated logging of the *exact same content* for the same file within a very short timeframe. This could indicate a system performing frequent automatic saves or a logging mechanism that captures file state at regular intervals, even if no code modifications have occurred. The code itself shows recurring patterns in its design, such as the use of queues and events for inter-process/inter-thread communication, and error handling with logging for various operations (camera, STM, Android).

## 3:38:03 PM
All changes occur in the file `c:\Users\zhiha\MDP_Shared\MDP-Maxxing\RPI_Server\Week9.py`. The modifications show an active development and debugging phase focusing on image recognition, STM communication, and Android interaction.

**Key File-Specific Updates:**

*   **Initial Setup (10/11/2025, 2:50:40 PM):**
    *   The `RaspberryPi` class is defined, managing queues for Android (`android_queue`, `rpi_action_queue`) and STM (`stm_queue`), communication links (`AndroidLink`, `STMLink`), and camera functionalities (`PiCamera`).
    *   It includes shared variables `self.obstacles` (a list of dictionaries for obstacle data) and `self.obstacle_order` (a list to track obstacle processing order).
    *   The `stm_queue_listener` contained logic to capture images (`<SNAPS>` command), upload them to an `IMAGE_SERVER`, and send image recognition results (including obstacle ID, image ID, x, y, d coordinates) back to Android. It explicitly removed obstacles from `self.obstacle_order` after processing.

*   **Error Handling and Refactor (10/11/2025, 2:52:25 PM to 3:24:47 PM):**
    *   Minor error logging for server responses and image capture failures was added in `stm_queue_listener`.
    *   **Significant Refactor:** The `self.obstacle_order` list was removed and replaced by a simple integer `self.obstacle_num` to track the current obstacle being processed. This necessitated changes in how image capture and related Android messages identified obstacles.
    *   New image recognition logic was introduced for `<SNAPS>` commands: images are uploaded, and if annotated, the `data['label']` (38 or 39) triggers sending `<LEFTS>` or `<RIGHT>` commands to STM.
    *   Messages for failed image capture and retries were added to the `android_queue`.
    *   A bug was introduced where the `image-rec` Android message still attempted to reference `curr_obstacle` from `self.obstacles`, even though `curr_obstacle` was no longer defined.

*   **Logic Refinements (10/11/2025, 3:25:41 PM to 3:26:38 PM):**
    *   The incrementing of `self.obstacle_num` was adjusted, occurring even if the image server returned an error.
    *   The logic for detecting left (label 39) and right (label 38) arrows was swapped to correct the corresponding STM commands (`<LEFTS>` and `<RIGHT>`).

*   **Communication and Feature Changes (10/11/2025, 3:33:20 PM):**
    *   The `send_and_wait` method was altered to no longer wait for the `stm_done` event (it now effectively skips the completion acknowledgment from STM), potentially impacting command reliability.
    *   **Major Functional Change:** The detailed `image-rec` Android messages, which previously included `obstacle-id`, `image-id`, `x`, `y`, `d` coordinates, were removed from the image recognition success path. Now, upon successful annotation, only a log message is generated, significantly reducing the information sent to Android about recognized obstacles.
    *   Improved error handling within the `stm_queue_listener` for `<SNAPS>` commands, allowing the loop to `continue` after exceptions.

*   **Further Refactor in Android Communication (10/11/2025, 3:34:00 PM to 3:36:35 PM):**
    *   The `send_and_wait` method's `timeout` parameter was reduced from `15.0` to `3.0` seconds.
    *   **Crucial Architectural Change:** The handling of the `'sendArena'` message category in the `recv_android` method was completely revamped. Originally, this message parsed and stored detailed obstacle information in `self.obstacles` and queued a `PiAction`. In the latest version, receiving a `'sendArena'` message *directly* appends an `"<START>"` command to the `stm_queue`, bypassing all prior obstacle data parsing and RPi-side storage of arena details. This implies that obstacle definition is no longer managed by the RPI upon receiving the 'sendArena' command.

**Timestamps of Significant Changes:**

*   **10/11/2025, 2:50:40 PM:** Baseline for `RaspberryPi` class, initial image processing and obstacle tracking logic.
*   **10/11/2025, 3:24:47 PM:** Major refactor replacing `obstacle_order` with `obstacle_num` and introducing initial image recognition for arrow commands.
*   **10/11/2025, 3:26:38 PM:** Correction of arrow direction logic in image recognition.
*   **10/11/2025, 3:33:20 PM:** Altered `send_and_wait` behavior (bypassing `stm_done` wait) and removed detailed `image-rec` messages to Android.
*   **10/11/2025, 3:34:00 PM:** Fundamental change to `'sendArena'` message handling, now directly initiating STM `<START>` instead of processing obstacle data, and reduction of `send_and_wait` timeout.

**Patterns and Recurring Elements:**

*   **Iterative Debugging and Refinement:** Many changes occur in quick succession, indicating active development, testing, and immediate adjustments to logic, especially around image recognition and STM command flow.
*   **Focus on STM and Android Communication:** The `stm_queue_listener` and `recv_android` methods are the most frequently modified, highlighting the core interaction between the Raspberry Pi, the STM microcontroller, and the Android application.
*   **Evolution of Obstacle Handling:** The system moved from a more complex obstacle management (using `obstacle_order` and detailed Android feedback) to a simpler, sequential `obstacle_num` counter, eventually removing the RPi's direct processing of obstacle coordinates from Android and streamlining `sendArena` to a start command.
*   **Error Handling Improvements:** Throughout the log, additional `try-except` blocks and debug logs are added to make the system more robust against communication failures and processing errors.